(function(){var t,e,i={}.hasOwnProperty,o=function(t,e){function o(){this.constructor=t}for(var r in e)i.call(e,r)&&(t[r]=e[r]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},r=function(t,e){return function(){return t.apply(e,arguments)}};t=window.jQuery,e=window.gifdropApp={init:function(){return this.settings=gifdropSettings,this.$wrapper=t("body > #outer-wrapper"),this.$modal=t("body > #modal"),this.images=new this.Images(_.toArray(this.settings.attachments)),this.modalView=new e.ModalView({collection:this.images}),this.modalView.render(),this.$modal.replaceWith(this.modalView.el),this.modalView.views.ready(),this.view=new this.MainView({collection:this.images}),this.view.render(),this.$wrapper.html(this.view.el),this.view.views.ready(),this.$browser=t(".browser"),this.modalView.listenTo(this.modalView,"modalOpen",function(){return t("body").addClass("modal-open")}),this.modalView.listenTo(this.modalView,"modalClosed",function(){return t("body").removeClass("modal-open"),t("input.search").focus()}),this.initUploads()},initUploads:function(){var t,i,o,r,n;return i=function(t,e){},o=function(t){},t=function(){return alert("error")},r=function(t){var i,o,r,n;return console.log(t),i=t.attributes,o=i.sizes.full,n=i.sizes["full-gif-static"]||o,r={id:t.id,width:o.width,height:o.height,title:i.title,src:o.url,"static":n.url},e.images.add(r,{at:0})},n=new wp.Uploader({container:this.$wrapper,browser:this.$browser,dropzone:this.$wrapper,success:r,error:t,params:{post_id:this.settings.id,provide_full_gif_static:!0},supports:{dragdrop:!0},plupload:{runtimes:"html5",filters:[{title:"Image",extensions:"jpg,jpeg,gif,png"}]}}),n.supports.dragdrop?(n.uploader.bind("BeforeUpload",o),n.uploader.bind("UploadProgress",i)):(n.uploader.destroy(),n=null)},restrictHeight:function(t,e){return e>1.5*t?1.5*t:e},fitTo:function(t,e,i){var o;return o=e/t,[i,Math.round(i*o)]},sync:function(t){return t=_.defaults(t||{},{context:this}),t.data=_.defaults(t.data||{},{action:"gifdrop",post_id:this.settings.id,_ajax_nonce:this.settings.nonce}),wp.ajax.send(t)}},e.View=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return o(e,t),e.prototype.render=function(){var t;return t=e.__super__.render.apply(this,arguments),"function"==typeof this.postRender&&this.postRender(),t},e.prototype.prepare=function(){var t;return null!=(t=this.model)&&"function"==typeof t.toJSON?t.toJSON():void 0},e}(wp.Backbone.View),e.BrowserView=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return o(e,t),e.prototype.className="browser",e}(wp.Backbone.View),e.Image=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,t),i.prototype.initialize=function(){var t,i,o;return o=e.fitTo(this.get("width"),this.get("height"),320),i=o[0],t=o[1],this.set({imgWidth:i,divHeight:e.restrictHeight(i,t),imgHeight:t})},i.prototype._sync=function(t,i){return e.sync({context:this,success:i.success,error:i.error,data:t})},i.prototype.sync=function(t,e,i){var o;return"update"===t?(o={subaction:t,model:JSON.stringify(e.toJSON())},this._sync(o,i)):void 0},i}(Backbone.Model),e.ImageContainer=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,t),i.prototype.model=e.Image,i}(Backbone.Collection),e.Images=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,t),i.prototype.initialize=function(t){var i,o;return i=function(){var i,r,n;for(n=[],i=0,r=t.length;r>i;i++)o=t[i],n.push(new e.Image(o));return n}(),this.filtered=new e.ImageContainer(i),this.listenTo(this.filtered,"change",this.changeMain)},i.prototype.changeMain=function(t){return this.get(t.get("id")).set(t.toJSON())},i.prototype._findGifs=function(t){var e,i,o,r;return console.log("Searching for",t),t.length>2?(r=_.map(t.split(/[ _-]/),function(t){return t.toLowerCase()}),e=_.last(r),o=this.filter(function(t){var i,o,n;return n=_.map(t.get("title").split(/[ _-]/),function(t){return t.toLowerCase()}),i=function(){var t,i,s;for(s=[],t=0,i=r.length;i>t;t++)o=r[t],s.push(function(t){var i,o,r,s,a,u,p,l,c;for(r=function(){var t,e,i,o;for(i=["s","es","ing"],o=[],t=0,e=i.length;e>t;t++)s=i[t],o.push(new RegExp(s+"$"));return o}(),u=0,l=n.length;l>u;u++){if(a=n[u],i=!1,e===t&&(i=0===a.indexOf(e)),!i)for(i=a===t,p=0,c=r.length;c>p;p++)o=r[p],i||(i=a+s===t),i||(i=a===t+s),i||(i=a.replace(o,"")===t),i||(i=a===t.replace(o,""));if(i)return i}}(o));return s}(),i=_.filter(i,function(t){return t}),i.length===r.length}),i={}):(o=this.models,i={all:!0}),[o,i]},i.prototype.findGifs=function(t){var e,i,o;return null==this.memoizedFindGifs&&(this.memoizedFindGifs=_.memoize(this._findGifs)),o=this.memoizedFindGifs(t),i=o[0],e=o[1],console.log("Search results",i.length),_.isEqual(this.filtered.pluck("id"),_.pluck(i,"id"))?void 0:this.filtered.reset(i,e)},i}(e.ImageContainer),e.MainView=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,t),i.prototype.className="wrapper",i.prototype.initialize=function(){return this.views.add(new e.ImageNavView({collection:this.collection})),this.views.add(new e.ImagesListView({collection:this.collection})),this.views.add(new e.BrowserView)},i}(e.View),e.ImageNavView=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return o(e,t),e.prototype.className="nav",e.prototype.template=wp.template("nav"),e.prototype.events={"keyup input.search":"search"},e.prototype.lastSearch="",e.prototype._search=function(t){return this.collection.findGifs(t)},e.prototype.search=function(){return null==this.debouncedSearch&&(this.debouncedSearch=_.debounce(this._search,250)),this.debouncedSearch(this.$search.val())},e.prototype.postRender=function(){return this.$search=this.$("input.search")},e.prototype.ready=function(){return this.$search.focus()},e}(e.View),e.ImagesListView=function(i){function n(){return this.masonry=r(this.masonry,this),n.__super__.constructor.apply(this,arguments)}return o(n,i),n.prototype.className="gifs",n.prototype.masonryEnabled=!1,n.prototype.initialize=function(){return this.setSubviews(),this.listenTo(this.collection,"add",this.addNew),this.listenTo(this,"newView",this.animateItemIn),this.listenTo(this.collection.filtered,"reset",this.filterIsotope)},n.prototype.animateItemIn=function(t,e){var i,o;if(o=this.collection.filtered.indexOf(t),i=this.collection.filtered.length-1,this.masonryEnabled)switch(o){case 0:return this.$el.isotope("prepended",e);case i:return this.$el.isotope("appended",e);default:return this.$el.isotope("reloadItems").isotope()}},n.prototype.addNew=function(t,e,i){return this.addView(t,{at:null!=i?i.at:void 0})},n.prototype.addView=function(t,i){var o;return o=new e.ImageListView({model:t}),this.views.add(o,i)},n.prototype.filterIsotope=function(e,i){var o,r,n,s,a,u;for(t("body").animate({scrollTop:0},200),r=e.pluck("id"),o=(null!=i?i.all:void 0)?function(){return!0}:function(){return _.contains(_.chain(r).map(function(t){return"gif-"+t}).value(),t(this).attr("id"))},u=this.views.get(),s=0,a=u.length;a>s;s++)n=u[s],_.contains(r,n.model.get("id"))&&n.trigger("loadImage");return this.$el.isotope({filter:o})},n.prototype.setSubviews=function(){var t;return t=_.map(this.collection.models,function(t){return new e.ImageListView({model:t})}),this.views.set(t)},n.prototype.ready=function(){return t(function(t){return function(){return t.masonry()}}(this))},n.prototype.masonry=function(){return this.masonryEnabled=!0,this.$el.isotope({layoutMode:"masonry",itemSelector:".gif",sortBy:"original-order",masonry:{columnWidth:320,gutter:0}})},n}(e.View),e.ImageListView=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,t),i.prototype.className="gif",i.prototype.template=wp.template("gif"),i.prototype.events={mouseover:"mouseover",mouseout:"mouseout",click:"click"},i.prototype.initialize=function(){return this.listenTo(this,"loadImage",this.loadImage)},i.prototype.attributes=function(){return{id:"gif-"+this.model.get("id")}},i.prototype.mouseover=function(){return this.$img.attr({src:this.model.get("src")}),this.unCrop()},i.prototype.mouseout=function(){return this.$img.attr({src:this.model.get("static")}),this.restoreCrop()},i.prototype.click=function(){var t;return t=new e.SingleView({model:this.model}),e.modalView.open(),e.modalView.views.set(t),this.mouseout()},i.prototype.unCrop=function(){var t,e,i;return this.model.get("imgHeight")!==this.model.get("divHeight")?(i=this.model.get("imgWidth")/this.model.get("imgHeight"),e=this.model.get("divHeight")*i,t=this.model.get("imgWidth")-e,this.$el.css({padding:"0 "+t/2+"px"})):void 0},i.prototype.restoreCrop=function(){return this.model.get("imgHeight")!==this.model.get("divHeight")?this.$el.css({padding:0,"z-index":"auto"}):void 0},i.prototype.crop=function(){return this.$el.css({height:""+this.model.get("divHeight")+"px"})},i.prototype.loadImage=function(){return this.$img.trigger("appear")},i.prototype.postRender=function(){return this.crop(),this.$img=this.$("> img")},i.prototype.ready=function(){return this.$img.show().lazyload(),this.views.parent.trigger("newView",this.model,this.$el)},i}(e.View),e.ModalView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return o(i,e),i.prototype.attributes={id:"modal"},i.prototype.events={click:"click"},i.prototype.keyup=function(t){var e,i,o,r;if(27===t.which){for(r=this.views.get(),i=0,o=r.length;o>i;i++)e=r[i],e.trigger("modalClosing:esc");return this.close()}},i.prototype.open=function(){return this.$el.show().addClass("open"),this.trigger("modalOpen")},i.prototype.close=function(){return this.$el.hide().removeClass("open"),this.trigger("modalClosed")},i.prototype.click=function(t){var e,i,o,r;if(this.el===t.target){for(r=this.views.get(),i=0,o=r.length;o>i;i++)e=r[i],e.trigger("modalClosing:click");return this.close()}},i.prototype.ready=function(){return t("body").on("keyup",function(t){return function(e){var i,o,r,n;if(27===e.which){for(n=t.views.get(),o=0,r=n.length;r>o;o++)i=n[o],i.trigger("modalClosing:esc");return t.close()}}}(this))},i}(e.View),e.SingleView=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return o(e,t),e.prototype.template=wp.template("single"),e.prototype.className="modal-content",e.prototype.events={"keyup input":"keyup"},e.prototype.initialize=function(){return this.listenTo(this,"modalClosing:click",this.save)},e.prototype.save=function(){return this.model.set({title:this.$title.val()}),console.log("Saving",this.$title.val()),this.model.save()},e.prototype.keyup=function(t){return 13===t.which&&(this.save(),this.views.parent.close()),27===t.which?(this.$title.val(this.model.get("title")),this.views.parent.close()):void 0},e.prototype.postRender=function(){return this.$title=this.$("input.title")},e.prototype.ready=function(){return this.$title.focus().val(this.$title.val())},e}(e.View)}).call(this);